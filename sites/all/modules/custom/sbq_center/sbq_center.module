<?php

//https://jxkh.manageprojects.com/projects/307web/tasks/3
// 医生群体关注
define('SBQ_CENTER_NODE_LIMIT', 1);

/**
 * Implements hook_node_access().
 */

function sbq_center_node_access($node, $op, $account) {
	$limit_content_type = 'sbq_center';
	if ($op == 'create' && $node == $limit_content_type) {
    $node_count = db_query('SELECT nid FROM {node} WHERE type = :type AND uid = :uid', array( ':type' => $limit_content_type, ':uid' => $account->uid ))->rowCount();
    if ($node_count >= SBQ_CENTER_NODE_LIMIT) {
    	// drupal_set_message(t("Your can't create antoher page of !type",array('!type'=>$limit_content_type)), 'status', FALSE);
    	drupal_set_message(t("The page your are creating was limitd!"), 'status', FALSE);
      return NODE_ACCESS_DENY;
    }
    return NODE_ACCESS_ALLOW;
  }
  return NODE_ACCESS_IGNORE;
}

// $content_type_import_sbq_center = array(
//   'bundles' => array(
//     'sbq_center' => (object) array(
//       'type' => 'sbq_center',
//       'name' => '中心主页',
//       'base' => 'node_content',
//       'module' => 'node',
//       'description' => '',
//       'help' => '',
//       'has_title' => '1',
//       'title_label' => '标题',
//       'custom' => '1',
//       'modified' => '1',
//       'locked' => '0',
//       'disabled' => '0',
//       'orig_type' => 'sbq_center',
//       'disabled_changed' => FALSE,
//       'bc_entity_type' => 'node',
//     ),
//     'sbq_center_edu' => (object) array(
//       'type' => 'sbq_center_edu',
//       'name' => '健康教育',
//       'base' => 'node_content',
//       'module' => 'node',
//       'description' => '',
//       'help' => '',
//       'has_title' => '1',
//       'title_label' => 'Title',
//       'custom' => '1',
//       'modified' => '1',
//       'locked' => '0',
//       'disabled' => '0',
//       'orig_type' => 'sbq_center_edu',
//       'disabled_changed' => FALSE,
//       'bc_entity_type' => 'node',
//     ),
//   ),
//   'fields' => array(
//     'body' => array(
//       'entity_types' => array(
//         0 => 'node',
//       ),
//       'translatable' => '0',
//       'settings' => array(
//         'profile2_private' => FALSE,
//       ),
//       'storage' => array(
//         'type' => 'field_sql_storage',
//         'settings' => array(),
//         'module' => 'field_sql_storage',
//         'active' => '1',
//         'details' => array(
//           'sql' => array(
//             'FIELD_LOAD_CURRENT' => array(
//               'field_data_body' => array(
//                 'value' => 'body_value',
//                 'summary' => 'body_summary',
//                 'format' => 'body_format',
//               ),
//             ),
//             'FIELD_LOAD_REVISION' => array(
//               'field_revision_body' => array(
//                 'value' => 'body_value',
//                 'summary' => 'body_summary',
//                 'format' => 'body_format',
//               ),
//             ),
//           ),
//         ),
//       ),
//       'foreign keys' => array(
//         'format' => array(
//           'table' => 'filter_format',
//           'columns' => array(
//             'format' => 'format',
//           ),
//         ),
//       ),
//       'indexes' => array(
//         'format' => array(
//           0 => 'format',
//         ),
//       ),
//       'field_permissions' => array(
//         'type' => '0',
//       ),
//       'field_name' => 'body',
//       'type' => 'text_with_summary',
//       'module' => 'text',
//       'active' => '1',
//       'locked' => '0',
//       'cardinality' => '1',
//       'deleted' => '0',
//       'columns' => array(
//         'value' => array(
//           'type' => 'text',
//           'size' => 'big',
//           'not null' => FALSE,
//         ),
//         'summary' => array(
//           'type' => 'text',
//           'size' => 'big',
//           'not null' => FALSE,
//         ),
//         'format' => array(
//           'type' => 'varchar',
//           'length' => 255,
//           'not null' => FALSE,
//         ),
//       ),
//       'bundles' => array(
//         'node' => array(
//           0 => 'page',
//           1 => 'article',
//           2 => 'sbq_topic',
//           3 => 'news',
//           4 => 'hospital',
//           5 => 'hospital_blacklist',
//           6 => 'illness_diagnosis',
//           7 => 'friend_activities',
//           8 => 'doctor_legend',
//           9 => 'curing_guide',
//           10 => 'answer',
//           11 => 'question',
//           12 => 'blog',
//           13 => 'hospital_department',
//           14 => 'grow_records',
//           15 => 'doctor_group',
//           16 => 'general_group',
//           17 => 'post',
//           18 => 'tech_test',
//           19 => 'wiki_child',
//           20 => 'tech',
//           21 => 'wiki',
//           22 => 'activity',
//           23 => 'red_list',
//           24 => 'black_list',
//           25 => 'webform',
//           26 => 'sbq_center',
//           27 => 'sbq_center_edu',
//         ),
//       ),
//     ),
//     'field_doctor_hospital_phone' => array(
//       'translatable' => '0',
//       'entity_types' => array(),
//       'settings' => array(
//         'max_length' => '25',
//         'profile2_private' => FALSE,
//       ),
//       'storage' => array(
//         'type' => 'field_sql_storage',
//         'settings' => array(),
//         'module' => 'field_sql_storage',
//         'active' => '1',
//         'details' => array(
//           'sql' => array(
//             'FIELD_LOAD_CURRENT' => array(
//               'field_data_field_doctor_hospital_phone' => array(
//                 'value' => 'field_doctor_hospital_phone_value',
//                 'format' => 'field_doctor_hospital_phone_format',
//               ),
//             ),
//             'FIELD_LOAD_REVISION' => array(
//               'field_revision_field_doctor_hospital_phone' => array(
//                 'value' => 'field_doctor_hospital_phone_value',
//                 'format' => 'field_doctor_hospital_phone_format',
//               ),
//             ),
//           ),
//         ),
//       ),
//       'foreign keys' => array(
//         'format' => array(
//           'table' => 'filter_format',
//           'columns' => array(
//             'format' => 'format',
//           ),
//         ),
//       ),
//       'indexes' => array(
//         'format' => array(
//           0 => 'format',
//         ),
//       ),
//       'field_name' => 'field_doctor_hospital_phone',
//       'type' => 'text',
//       'module' => 'text',
//       'active' => '1',
//       'locked' => '0',
//       'cardinality' => '2',
//       'deleted' => '0',
//       'columns' => array(
//         'value' => array(
//           'type' => 'varchar',
//           'length' => '25',
//           'not null' => FALSE,
//         ),
//         'format' => array(
//           'type' => 'varchar',
//           'length' => 255,
//           'not null' => FALSE,
//         ),
//       ),
//       'bundles' => array(
//         'profile2' => array(
//           0 => 'doctor_private_profile',
//         ),
//         'node' => array(
//           0 => 'sbq_center',
//         ),
//       ),
//     ),
//     'field_sbq_addr_text' => array(
//       'translatable' => '0',
//       'entity_types' => array(),
//       'settings' => array(
//         'max_length' => '255',
//         'profile2_private' => FALSE,
//       ),
//       'storage' => array(
//         'type' => 'field_sql_storage',
//         'settings' => array(),
//         'module' => 'field_sql_storage',
//         'active' => '1',
//         'details' => array(
//           'sql' => array(
//             'FIELD_LOAD_CURRENT' => array(
//               'field_data_field_sbq_addr_text' => array(
//                 'value' => 'field_sbq_addr_text_value',
//                 'format' => 'field_sbq_addr_text_format',
//               ),
//             ),
//             'FIELD_LOAD_REVISION' => array(
//               'field_revision_field_sbq_addr_text' => array(
//                 'value' => 'field_sbq_addr_text_value',
//                 'format' => 'field_sbq_addr_text_format',
//               ),
//             ),
//           ),
//         ),
//       ),
//       'foreign keys' => array(
//         'format' => array(
//           'table' => 'filter_format',
//           'columns' => array(
//             'format' => 'format',
//           ),
//         ),
//       ),
//       'indexes' => array(
//         'format' => array(
//           0 => 'format',
//         ),
//       ),
//       'field_name' => 'field_sbq_addr_text',
//       'type' => 'text',
//       'module' => 'text',
//       'active' => '1',
//       'locked' => '0',
//       'cardinality' => '1',
//       'deleted' => '0',
//       'columns' => array(
//         'value' => array(
//           'type' => 'varchar',
//           'length' => '255',
//           'not null' => FALSE,
//         ),
//         'format' => array(
//           'type' => 'varchar',
//           'length' => 255,
//           'not null' => FALSE,
//         ),
//       ),
//       'bundles' => array(
//         'node' => array(
//           0 => 'sbq_center',
//         ),
//       ),
//     ),
//     'field_sbq_center_edu_switch' => array(
//       'translatable' => '0',
//       'entity_types' => array(),
//       'settings' => array(
//         'max_length' => '20',
//         'profile2_private' => FALSE,
//       ),
//       'storage' => array(
//         'type' => 'field_sql_storage',
//         'settings' => array(),
//         'module' => 'field_sql_storage',
//         'active' => '1',
//         'details' => array(
//           'sql' => array(
//             'FIELD_LOAD_CURRENT' => array(
//               'field_data_field_sbq_center_edu_switch' => array(
//                 'value' => 'field_sbq_center_edu_switch_value',
//                 'format' => 'field_sbq_center_edu_switch_format',
//               ),
//             ),
//             'FIELD_LOAD_REVISION' => array(
//               'field_revision_field_sbq_center_edu_switch' => array(
//                 'value' => 'field_sbq_center_edu_switch_value',
//                 'format' => 'field_sbq_center_edu_switch_format',
//               ),
//             ),
//           ),
//         ),
//       ),
//       'foreign keys' => array(
//         'format' => array(
//           'table' => 'filter_format',
//           'columns' => array(
//             'format' => 'format',
//           ),
//         ),
//       ),
//       'indexes' => array(
//         'format' => array(
//           0 => 'format',
//         ),
//       ),
//       'field_name' => 'field_sbq_center_edu_switch',
//       'type' => 'text',
//       'module' => 'text',
//       'active' => '1',
//       'locked' => '0',
//       'cardinality' => '1',
//       'deleted' => '0',
//       'columns' => array(
//         'value' => array(
//           'type' => 'varchar',
//           'length' => '20',
//           'not null' => FALSE,
//         ),
//         'format' => array(
//           'type' => 'varchar',
//           'length' => 255,
//           'not null' => FALSE,
//         ),
//       ),
//       'bundles' => array(
//         'node' => array(
//           0 => 'sbq_center',
//         ),
//       ),
//     ),
//     'field_sbq_center_edu_tax' => array(
//       'translatable' => '0',
//       'entity_types' => array(),
//       'settings' => array(
//         'allowed_values' => array(
//           0 => array(
//             'vocabulary' => 'sbq_center_edu_tag',
//             'parent' => '0',
//           ),
//         ),
//         'profile2_private' => FALSE,
//       ),
//       'storage' => array(
//         'type' => 'field_sql_storage',
//         'settings' => array(),
//         'module' => 'field_sql_storage',
//         'active' => '1',
//         'details' => array(
//           'sql' => array(
//             'FIELD_LOAD_CURRENT' => array(
//               'field_data_field_sbq_center_edu_tax' => array(
//                 'tid' => 'field_sbq_center_edu_tax_tid',
//               ),
//             ),
//             'FIELD_LOAD_REVISION' => array(
//               'field_revision_field_sbq_center_edu_tax' => array(
//                 'tid' => 'field_sbq_center_edu_tax_tid',
//               ),
//             ),
//           ),
//         ),
//       ),
//       'foreign keys' => array(
//         'tid' => array(
//           'table' => 'taxonomy_term_data',
//           'columns' => array(
//             'tid' => 'tid',
//           ),
//         ),
//       ),
//       'indexes' => array(
//         'tid' => array(
//           0 => 'tid',
//         ),
//       ),
//       'field_name' => 'field_sbq_center_edu_tax',
//       'type' => 'taxonomy_term_reference',
//       'module' => 'taxonomy',
//       'active' => '1',
//       'locked' => '0',
//       'cardinality' => '1',
//       'deleted' => '0',
//       'columns' => array(
//         'tid' => array(
//           'type' => 'int',
//           'unsigned' => TRUE,
//           'not null' => FALSE,
//         ),
//       ),
//       'bundles' => array(
//         'node' => array(
//           0 => 'sbq_center_edu',
//         ),
//       ),
//     ),
//     'field_sbq_center_notify' => array(
//       'translatable' => '0',
//       'entity_types' => array(),
//       'settings' => array(
//         'profile2_private' => FALSE,
//       ),
//       'storage' => array(
//         'type' => 'field_sql_storage',
//         'settings' => array(),
//         'module' => 'field_sql_storage',
//         'active' => '1',
//         'details' => array(
//           'sql' => array(
//             'FIELD_LOAD_CURRENT' => array(
//               'field_data_field_sbq_center_notify' => array(
//                 'value' => 'field_sbq_center_notify_value',
//                 'format' => 'field_sbq_center_notify_format',
//               ),
//             ),
//             'FIELD_LOAD_REVISION' => array(
//               'field_revision_field_sbq_center_notify' => array(
//                 'value' => 'field_sbq_center_notify_value',
//                 'format' => 'field_sbq_center_notify_format',
//               ),
//             ),
//           ),
//         ),
//       ),
//       'foreign keys' => array(
//         'format' => array(
//           'table' => 'filter_format',
//           'columns' => array(
//             'format' => 'format',
//           ),
//         ),
//       ),
//       'indexes' => array(
//         'format' => array(
//           0 => 'format',
//         ),
//       ),
//       'field_name' => 'field_sbq_center_notify',
//       'type' => 'text_long',
//       'module' => 'text',
//       'active' => '1',
//       'locked' => '0',
//       'cardinality' => '1',
//       'deleted' => '0',
//       'columns' => array(
//         'value' => array(
//           'type' => 'text',
//           'size' => 'big',
//           'not null' => FALSE,
//         ),
//         'format' => array(
//           'type' => 'varchar',
//           'length' => 255,
//           'not null' => FALSE,
//         ),
//       ),
//       'bundles' => array(
//         'node' => array(
//           0 => 'sbq_center',
//         ),
//       ),
//     ),
//     'field_sbq_center_team' => array(
//       'translatable' => '0',
//       'entity_types' => array(),
//       'settings' => array(
//         'profile2_private' => FALSE,
//         'target_type' => 'user',
//         'handler' => 'views',
//         'handler_settings' => array(
//           'view' => array(
//             'view_name' => 'sbq_center_experts',
//             'display_name' => 'entityreference_1',
//             'args' => array(),
//           ),
//           'behaviors' => array(
//             'views-select-list' => array(
//               'status' => 0,
//             ),
//           ),
//         ),
//       ),
//       'storage' => array(
//         'type' => 'field_sql_storage',
//         'settings' => array(),
//         'module' => 'field_sql_storage',
//         'active' => '1',
//         'details' => array(
//           'sql' => array(
//             'FIELD_LOAD_CURRENT' => array(
//               'field_data_field_sbq_center_team' => array(
//                 'target_id' => 'field_sbq_center_team_target_id',
//               ),
//             ),
//             'FIELD_LOAD_REVISION' => array(
//               'field_revision_field_sbq_center_team' => array(
//                 'target_id' => 'field_sbq_center_team_target_id',
//               ),
//             ),
//           ),
//         ),
//       ),
//       'foreign keys' => array(
//         'node' => array(
//           'table' => 'node',
//           'columns' => array(
//             'target_id' => 'nid',
//           ),
//         ),
//       ),
//       'indexes' => array(
//         'target_id' => array(
//           0 => 'target_id',
//         ),
//       ),
//       'field_name' => 'field_sbq_center_team',
//       'type' => 'entityreference',
//       'module' => 'entityreference',
//       'active' => '1',
//       'locked' => '0',
//       'cardinality' => '5',
//       'deleted' => '0',
//       'columns' => array(
//         'target_id' => array(
//           'description' => 'The id of the target entity.',
//           'type' => 'int',
//           'unsigned' => TRUE,
//           'not null' => TRUE,
//         ),
//       ),
//       'bundles' => array(
//         'node' => array(
//           0 => 'sbq_center',
//         ),
//       ),
//     ),
//     'field_tags' => array(
//       'entity_types' => array(),
//       'field_permissions' => array(
//         'type' => '0',
//       ),
//       'foreign keys' => array(
//         'tid' => array(
//           'columns' => array(
//             'tid' => 'tid',
//           ),
//           'table' => 'taxonomy_term_data',
//         ),
//       ),
//       'indexes' => array(
//         'tid' => array(
//           0 => 'tid',
//         ),
//       ),
//       'settings' => array(
//         'allowed_values' => array(
//           0 => array(
//             'vocabulary' => 'tags',
//             'parent' => 0,
//           ),
//         ),
//         'profile2_private' => FALSE,
//       ),
//       'translatable' => '0',
//       'storage' => array(
//         'type' => 'field_sql_storage',
//         'settings' => array(),
//         'module' => 'field_sql_storage',
//         'active' => '1',
//         'details' => array(
//           'sql' => array(
//             'FIELD_LOAD_CURRENT' => array(
//               'field_data_field_tags' => array(
//                 'tid' => 'field_tags_tid',
//               ),
//             ),
//             'FIELD_LOAD_REVISION' => array(
//               'field_revision_field_tags' => array(
//                 'tid' => 'field_tags_tid',
//               ),
//             ),
//           ),
//         ),
//       ),
//       'field_name' => 'field_tags',
//       'type' => 'taxonomy_term_reference',
//       'module' => 'taxonomy',
//       'active' => '1',
//       'locked' => '0',
//       'cardinality' => '5',
//       'deleted' => '0',
//       'columns' => array(
//         'tid' => array(
//           'type' => 'int',
//           'unsigned' => TRUE,
//           'not null' => FALSE,
//         ),
//       ),
//       'bundles' => array(
//         'node' => array(
//           0 => 'article',
//           1 => 'question',
//           2 => 'blog',
//           3 => 'sbq_center_edu',
//         ),
//       ),
//     ),
//     'group_group' => array(
//       'settings' => array(
//         'allowed_values' => array(
//           0 => 'Not a group',
//           1 => 'Group',
//         ),
//         'allowed_values_function' => '',
//       ),
//       'entity_types' => array(),
//       'translatable' => '0',
//       'storage' => array(
//         'type' => 'field_sql_storage',
//         'settings' => array(),
//         'module' => 'field_sql_storage',
//         'active' => '1',
//         'details' => array(
//           'sql' => array(
//             'FIELD_LOAD_CURRENT' => array(
//               'field_data_group_group' => array(
//                 'value' => 'group_group_value',
//               ),
//             ),
//             'FIELD_LOAD_REVISION' => array(
//               'field_revision_group_group' => array(
//                 'value' => 'group_group_value',
//               ),
//             ),
//           ),
//         ),
//       ),
//       'foreign keys' => array(),
//       'indexes' => array(
//         'value' => array(
//           0 => 'value',
//         ),
//       ),
//       'field_name' => 'group_group',
//       'type' => 'list_boolean',
//       'module' => 'list',
//       'active' => '1',
//       'locked' => '0',
//       'cardinality' => '1',
//       'deleted' => '0',
//       'columns' => array(
//         'value' => array(
//           'type' => 'int',
//           'not null' => FALSE,
//         ),
//       ),
//       'bundles' => array(
//         'node' => array(
//           0 => 'doctor_group',
//           1 => 'general_group',
//           2 => 'activity',
//           3 => 'sbq_center',
//         ),
//       ),
//     ),
//     'og_group_ref' => array(
//       'settings' => array(
//         'profile2_private' => FALSE,
//         'target_type' => 'node',
//         'handler' => 'og',
//         'handler_settings' => array(
//           'target_bundles' => array(),
//           'sort' => array(
//             'type' => 'none',
//           ),
//           'membership_type' => 'og_membership_type_default',
//           'behaviors' => array(
//             'og_behavior' => array(
//               'status' => TRUE,
//             ),
//             'views-select-list' => array(
//               'status' => 0,
//             ),
//           ),
//         ),
//         'handler_submit' => 'Change handler',
//       ),
//       'target_type' => 'node',
//       'entity_types' => array(),
//       'translatable' => '0',
//       'storage' => array(
//         'type' => 'field_sql_storage',
//         'settings' => array(),
//         'module' => 'field_sql_storage',
//         'active' => '1',
//         'details' => array(
//           'sql' => array(
//             'FIELD_LOAD_CURRENT' => array(
//               'field_data_og_group_ref' => array(
//                 'target_id' => 'og_group_ref_target_id',
//               ),
//             ),
//             'FIELD_LOAD_REVISION' => array(
//               'field_revision_og_group_ref' => array(
//                 'target_id' => 'og_group_ref_target_id',
//               ),
//             ),
//           ),
//         ),
//       ),
//       'foreign keys' => array(
//         'node' => array(
//           'table' => 'node',
//           'columns' => array(
//             'target_id' => 'nid',
//           ),
//         ),
//       ),
//       'indexes' => array(
//         'target_id' => array(
//           0 => 'target_id',
//         ),
//       ),
//       'field_name' => 'og_group_ref',
//       'type' => 'entityreference',
//       'module' => 'entityreference',
//       'active' => '1',
//       'locked' => '0',
//       'cardinality' => '-1',
//       'deleted' => '0',
//       'columns' => array(
//         'target_id' => array(
//           'description' => 'The id of the target entity.',
//           'type' => 'int',
//           'unsigned' => TRUE,
//           'not null' => TRUE,
//         ),
//       ),
//       'bundles' => array(
//         'node' => array(
//           0 => 'post',
//           1 => 'sbq_center_edu',
//         ),
//       ),
//     ),
//   ),
//   'instances' => array(
//     'body' => array(
//       0 => array(
//         'label' => 'Body',
//         'widget' => array(
//           'type' => 'text_textarea_with_summary',
//           'settings' => array(
//             'rows' => 20,
//             'summary_rows' => 5,
//           ),
//           'weight' => '31',
//           'module' => 'text',
//         ),
//         'settings' => array(
//           'display_summary' => TRUE,
//           'text_processing' => 1,
//           'user_register_form' => FALSE,
//         ),
//         'display' => array(
//           'default' => array(
//             'label' => 'hidden',
//             'type' => 'text_default',
//             'settings' => array(),
//             'module' => 'text',
//             'weight' => 1,
//           ),
//           'teaser' => array(
//             'label' => 'hidden',
//             'type' => 'text_summary_or_trimmed',
//             'settings' => array(
//               'trim_length' => 600,
//             ),
//             'module' => 'text',
//             'weight' => 1,
//           ),
//         ),
//         'required' => FALSE,
//         'description' => '',
//         'field_name' => 'body',
//         'entity_type' => 'node',
//         'bundle' => 'sbq_center',
//         'deleted' => '0',
//         'default_value' => NULL,
//       ),
//       1 => array(
//         'label' => 'Body',
//         'widget' => array(
//           'type' => 'text_textarea_with_summary',
//           'settings' => array(
//             'rows' => 20,
//             'summary_rows' => 5,
//           ),
//           'weight' => '31',
//           'module' => 'text',
//         ),
//         'settings' => array(
//           'display_summary' => TRUE,
//           'text_processing' => 1,
//           'user_register_form' => FALSE,
//         ),
//         'display' => array(
//           'default' => array(
//             'label' => 'hidden',
//             'type' => 'text_default',
//             'settings' => array(),
//             'module' => 'text',
//             'weight' => 1,
//           ),
//           'teaser' => array(
//             'label' => 'hidden',
//             'type' => 'text_summary_or_trimmed',
//             'settings' => array(
//               'trim_length' => 600,
//             ),
//             'module' => 'text',
//             'weight' => 1,
//           ),
//         ),
//         'required' => FALSE,
//         'description' => '',
//         'field_name' => 'body',
//         'entity_type' => 'node',
//         'bundle' => 'sbq_center_edu',
//         'deleted' => '0',
//         'default_value' => NULL,
//       ),
//     ),
//     'field_doctor_hospital_phone' => array(
//       0 => array(
//         'label' => '预约电话',
//         'widget' => array(
//           'weight' => '35',
//           'type' => 'text_textfield',
//           'module' => 'text',
//           'active' => 1,
//           'settings' => array(
//             'size' => '60',
//           ),
//         ),
//         'settings' => array(
//           'text_processing' => '0',
//           'better_formats' => array(
//             'allowed_formats_toggle' => 0,
//             'allowed_formats' => array(
//               'plain_text' => 'plain_text',
//               'sbq_full' => 'sbq_full',
//               'full_html' => 'full_html',
//               'sbq_simple' => 'sbq_simple',
//               'filtered_html' => 'filtered_html',
//               'php_code' => 'php_code',
//             ),
//             'default_order_toggle' => 0,
//             'default_order_wrapper' => array(
//               'formats' => array(
//                 'plain_text' => array(
//                   'weight' => '-1',
//                 ),
//                 'sbq_full' => array(
//                   'weight' => '0',
//                 ),
//                 'full_html' => array(
//                   'weight' => '0',
//                 ),
//                 'sbq_simple' => array(
//                   'weight' => '0',
//                 ),
//                 'filtered_html' => array(
//                   'weight' => '0',
//                 ),
//                 'php_code' => array(
//                   'weight' => '11',
//                 ),
//               ),
//             ),
//           ),
//           'user_register_form' => FALSE,
//         ),
//         'display' => array(
//           'default' => array(
//             'label' => 'above',
//             'type' => 'text_default',
//             'settings' => array(),
//             'module' => 'text',
//             'weight' => 4,
//           ),
//           'teaser' => array(
//             'type' => 'hidden',
//             'label' => 'above',
//             'settings' => array(),
//             'weight' => 0,
//           ),
//         ),
//         'required' => 0,
//         'description' => '',
//         'default_value' => NULL,
//         'field_name' => 'field_doctor_hospital_phone',
//         'entity_type' => 'node',
//         'bundle' => 'sbq_center',
//         'deleted' => '0',
//       ),
//     ),
//     'field_sbq_addr_text' => array(
//       0 => array(
//         'label' => '中心地址',
//         'widget' => array(
//           'weight' => '37',
//           'type' => 'text_textfield',
//           'module' => 'text',
//           'active' => 1,
//           'settings' => array(
//             'size' => '255',
//           ),
//         ),
//         'settings' => array(
//           'text_processing' => '0',
//           'better_formats' => array(
//             'allowed_formats_toggle' => 0,
//             'allowed_formats' => array(
//               'plain_text' => 'plain_text',
//               'sbq_full' => 'sbq_full',
//               'full_html' => 'full_html',
//               'sbq_simple' => 'sbq_simple',
//               'filtered_html' => 'filtered_html',
//               'php_code' => 'php_code',
//             ),
//             'default_order_toggle' => 0,
//             'default_order_wrapper' => array(
//               'formats' => array(
//                 'plain_text' => array(
//                   'weight' => '-1',
//                 ),
//                 'sbq_full' => array(
//                   'weight' => '0',
//                 ),
//                 'full_html' => array(
//                   'weight' => '0',
//                 ),
//                 'sbq_simple' => array(
//                   'weight' => '0',
//                 ),
//                 'filtered_html' => array(
//                   'weight' => '0',
//                 ),
//                 'php_code' => array(
//                   'weight' => '11',
//                 ),
//               ),
//             ),
//           ),
//           'user_register_form' => FALSE,
//         ),
//         'display' => array(
//           'default' => array(
//             'label' => 'above',
//             'type' => 'text_default',
//             'settings' => array(),
//             'module' => 'text',
//             'weight' => 6,
//           ),
//           'teaser' => array(
//             'type' => 'hidden',
//             'label' => 'above',
//             'settings' => array(),
//             'weight' => 0,
//           ),
//         ),
//         'required' => 1,
//         'description' => '',
//         'default_value' => NULL,
//         'field_name' => 'field_sbq_addr_text',
//         'entity_type' => 'node',
//         'bundle' => 'sbq_center',
//         'deleted' => '0',
//       ),
//     ),
//     'field_sbq_center_edu_switch' => array(
//       0 => array(
//         'label' => '健康教育',
//         'widget' => array(
//           'weight' => '33',
//           'type' => 'text_textfield',
//           'module' => 'text',
//           'active' => 1,
//           'settings' => array(
//             'size' => '20',
//           ),
//         ),
//         'settings' => array(
//           'text_processing' => '0',
//           'better_formats' => array(
//             'allowed_formats_toggle' => 0,
//             'allowed_formats' => array(
//               'plain_text' => 'plain_text',
//               'sbq_full' => 'sbq_full',
//               'full_html' => 'full_html',
//               'sbq_simple' => 'sbq_simple',
//               'filtered_html' => 'filtered_html',
//               'php_code' => 'php_code',
//             ),
//             'default_order_toggle' => 0,
//             'default_order_wrapper' => array(
//               'formats' => array(
//                 'plain_text' => array(
//                   'weight' => '-1',
//                 ),
//                 'sbq_full' => array(
//                   'weight' => '0',
//                 ),
//                 'full_html' => array(
//                   'weight' => '0',
//                 ),
//                 'sbq_simple' => array(
//                   'weight' => '0',
//                 ),
//                 'filtered_html' => array(
//                   'weight' => '0',
//                 ),
//                 'php_code' => array(
//                   'weight' => '11',
//                 ),
//               ),
//             ),
//           ),
//           'user_register_form' => FALSE,
//         ),
//         'display' => array(
//           'default' => array(
//             'label' => 'above',
//             'type' => 'text_default',
//             'settings' => array(),
//             'module' => 'text',
//             'weight' => 3,
//           ),
//           'teaser' => array(
//             'type' => 'hidden',
//             'label' => 'above',
//             'settings' => array(),
//             'weight' => 0,
//           ),
//         ),
//         'required' => 0,
//         'description' => '',
//         'default_value' => NULL,
//         'field_name' => 'field_sbq_center_edu_switch',
//         'entity_type' => 'node',
//         'bundle' => 'sbq_center',
//         'deleted' => '0',
//       ),
//     ),
//     'field_sbq_center_edu_tax' => array(
//       0 => array(
//         'label' => '分类',
//         'widget' => array(
//           'weight' => '34',
//           'type' => 'options_select',
//           'module' => 'options',
//           'active' => 1,
//           'settings' => array(),
//         ),
//         'settings' => array(
//           'user_register_form' => FALSE,
//         ),
//         'display' => array(
//           'default' => array(
//             'label' => 'above',
//             'type' => 'taxonomy_term_reference_link',
//             'settings' => array(),
//             'module' => 'taxonomy',
//             'weight' => 3,
//           ),
//           'teaser' => array(
//             'type' => 'hidden',
//             'label' => 'above',
//             'settings' => array(),
//             'weight' => 0,
//           ),
//         ),
//         'required' => 1,
//         'description' => '',
//         'default_value' => NULL,
//         'field_name' => 'field_sbq_center_edu_tax',
//         'entity_type' => 'node',
//         'bundle' => 'sbq_center_edu',
//         'deleted' => '0',
//       ),
//     ),
//     'field_sbq_center_notify' => array(
//       0 => array(
//         'label' => '中心公告',
//         'widget' => array(
//           'weight' => '32',
//           'type' => 'text_textarea',
//           'module' => 'text',
//           'active' => 1,
//           'settings' => array(
//             'rows' => '5',
//           ),
//         ),
//         'settings' => array(
//           'text_processing' => '0',
//           'better_formats' => array(
//             'allowed_formats_toggle' => 0,
//             'allowed_formats' => array(
//               'plain_text' => 'plain_text',
//               'sbq_full' => 'sbq_full',
//               'full_html' => 'full_html',
//               'sbq_simple' => 'sbq_simple',
//               'filtered_html' => 'filtered_html',
//               'php_code' => 'php_code',
//             ),
//             'default_order_toggle' => 0,
//             'default_order_wrapper' => array(
//               'formats' => array(
//                 'plain_text' => array(
//                   'weight' => '-1',
//                 ),
//                 'sbq_full' => array(
//                   'weight' => '0',
//                 ),
//                 'full_html' => array(
//                   'weight' => '0',
//                 ),
//                 'sbq_simple' => array(
//                   'weight' => '0',
//                 ),
//                 'filtered_html' => array(
//                   'weight' => '0',
//                 ),
//                 'php_code' => array(
//                   'weight' => '11',
//                 ),
//               ),
//             ),
//           ),
//           'user_register_form' => FALSE,
//         ),
//         'display' => array(
//           'default' => array(
//             'label' => 'above',
//             'type' => 'text_default',
//             'settings' => array(),
//             'module' => 'text',
//             'weight' => 2,
//           ),
//           'teaser' => array(
//             'type' => 'hidden',
//             'label' => 'above',
//             'settings' => array(),
//             'weight' => 0,
//           ),
//         ),
//         'required' => 0,
//         'description' => '',
//         'default_value' => NULL,
//         'field_name' => 'field_sbq_center_notify',
//         'entity_type' => 'node',
//         'bundle' => 'sbq_center',
//         'deleted' => '0',
//       ),
//     ),
//     'field_sbq_center_team' => array(
//       0 => array(
//         'label' => '专家团队',
//         'widget' => array(
//           'weight' => '36',
//           'type' => 'options_buttons',
//           'module' => 'options',
//           'active' => 1,
//           'settings' => array(),
//         ),
//         'settings' => array(
//           'behaviors' => array(
//             'prepopulate' => array(
//               'status' => 0,
//             ),
//           ),
//           'user_register_form' => FALSE,
//         ),
//         'display' => array(
//           'default' => array(
//             'label' => 'above',
//             'type' => 'entityreference_label',
//             'settings' => array(
//               'link' => FALSE,
//             ),
//             'module' => 'entityreference',
//             'weight' => 5,
//           ),
//           'teaser' => array(
//             'type' => 'hidden',
//             'label' => 'above',
//             'settings' => array(),
//             'weight' => 0,
//           ),
//         ),
//         'required' => 1,
//         'description' => '请选择专家！！iews定制！！！',
//         'default_value' => NULL,
//         'default_value_function' => '',
//         'field_name' => 'field_sbq_center_team',
//         'entity_type' => 'node',
//         'bundle' => 'sbq_center',
//         'deleted' => '0',
//       ),
//     ),
//     'field_tags' => array(
//       0 => array(
//         'label' => '标签',
//         'widget' => array(
//           'weight' => '33',
//           'type' => 'taxonomy_autocomplete',
//           'module' => 'taxonomy',
//           'active' => 0,
//           'settings' => array(
//             'size' => 60,
//             'autocomplete_path' => 'taxonomy/autocomplete',
//           ),
//         ),
//         'settings' => array(
//           'user_register_form' => FALSE,
//         ),
//         'display' => array(
//           'default' => array(
//             'label' => 'above',
//             'type' => 'taxonomy_term_reference_link',
//             'settings' => array(),
//             'module' => 'taxonomy',
//             'weight' => 2,
//           ),
//           'teaser' => array(
//             'type' => 'hidden',
//             'label' => 'above',
//             'settings' => array(),
//             'weight' => 0,
//           ),
//         ),
//         'required' => 0,
//         'description' => '',
//         'default_value' => NULL,
//         'field_name' => 'field_tags',
//         'entity_type' => 'node',
//         'bundle' => 'sbq_center_edu',
//         'deleted' => '0',
//       ),
//     ),
//     'group_group' => array(
//       0 => array(
//         'label' => 'Group',
//         'description' => 'Determine if this is an OG group.',
//         'display_label' => 1,
//         'widget' => array(
//           'module' => 'options',
//           'settings' => array(
//             'og_hide' => TRUE,
//             'display_label' => 0,
//           ),
//           'type' => 'options_onoff',
//           'weight' => '0',
//         ),
//         'default_value' => array(
//           0 => array(
//             'value' => 1,
//           ),
//         ),
//         'view modes' => array(
//           'full' => array(
//             'label' => 'Full',
//             'type' => 'og_group_subscribe',
//             'custom settings' => FALSE,
//           ),
//           'teaser' => array(
//             'label' => 'Teaser',
//             'type' => 'og_group_subscribe',
//             'custom settings' => FALSE,
//           ),
//         ),
//         'display' => array(
//           'default' => array(
//             'type' => 'og_group_subscribe',
//             'label' => 'above',
//             'settings' => array(
//               'field_name' => FALSE,
//             ),
//             'module' => 'og_ui',
//             'weight' => 0,
//           ),
//           'teaser' => array(
//             'type' => 'hidden',
//             'label' => 'above',
//             'settings' => array(),
//             'weight' => 0,
//           ),
//         ),
//         'settings' => array(
//           'user_register_form' => FALSE,
//         ),
//         'required' => FALSE,
//         'field_name' => 'group_group',
//         'entity_type' => 'node',
//         'bundle' => 'sbq_center',
//         'deleted' => '0',
//       ),
//     ),
//     'og_group_ref' => array(
//       0 => array(
//         'label' => 'Groups audience',
//         'widget' => array(
//           'type' => 'og_complex',
//           'module' => 'og',
//           'settings' => array(),
//           'weight' => '0',
//         ),
//         'settings' => array(
//           'behaviors' => array(
//             'og_widget' => array(
//               'status' => TRUE,
//               'default' => array(
//                 'widget_type' => 'options_select',
//               ),
//               'admin' => array(
//                 'widget_type' => 'entityreference_autocomplete',
//               ),
//             ),
//           ),
//           'user_register_form' => FALSE,
//         ),
//         'view modes' => array(
//           'full' => array(
//             'label' => 'Full',
//             'type' => 'og_list_default',
//             'custom settings' => FALSE,
//           ),
//           'teaser' => array(
//             'label' => 'Teaser',
//             'type' => 'og_list_default',
//             'custom settings' => FALSE,
//           ),
//         ),
//         'display' => array(
//           'default' => array(
//             'type' => 'og_list_default',
//             'label' => 'above',
//             'settings' => array(),
//             'module' => 'og_ui',
//             'weight' => 0,
//           ),
//           'teaser' => array(
//             'type' => 'hidden',
//             'label' => 'above',
//             'settings' => array(),
//             'weight' => 0,
//           ),
//         ),
//         'required' => FALSE,
//         'description' => '',
//         'field_name' => 'og_group_ref',
//         'entity_type' => 'node',
//         'bundle' => 'sbq_center_edu',
//         'deleted' => '0',
//         'default_value' => NULL,
//       ),
//     ),
//   ),
// );

/**
 * Implements hook_block_info().
 * This hook declares what blocks are provided by the module.
 */
function sbq_center_block_info() {
  $blocks['sbq_center_ask'] = array(
      'info' => t('Center: sbq ask form'),
      'cache' => DRUPAL_CACHE_PER_ROLE, // default
  );
  return $blocks;
}

function sbq_center_block_view($delta = '') {
  switch ($delta) {
    case 'sbq_center_ask':
      $block['subject'] = '';
      $block['content'] = _sbq_center_block_html($delta);
      break;
  }
  return isset($block) ? $block : '';
}

function _sbq_center_block_html($delta) {
  global $user;
  switch ($delta) {
    case 'sbq_center_ask':
      if ($user->uid) {
        module_load_include('inc', 'node', 'node.pages');
        $node = (object) array(
                'uid' => $user->uid,
                'name' => (isset($user->name) ? $user->name : ''),
                'type' => 'question',
                'language' => LANGUAGE_NONE
        );
        $question_node_form = drupal_get_form('question_node_form', $node);
        $block_html = '<div id="sbq-center-ask-form">'
            . render($question_node_form)
            . '</div>';
      } else {
        $block_html = '<div id="sbq-center-need-login">'
            . '<span>请'.l('登录', 'user/login').'或'.l('注册', 'customer/register').'后，进行提问。'.l('点击注册', 'customer/register').'</span>'
            . '</div>';
      }
      break;
    default:
      break;
  }
  return isset($block_html) ? $block_html : '';
}

/**
 * Implements hook_form_alter().
 */
function sbq_center_form_alter(&$form, &$form_state, $form_id) {
  if (isset($form['comment_body'])) {
    $form['comment_body'][LANGUAGE_NONE][0]['#title'] = t('Comment');
  }
  if (isset($form['body'])) {
    $form['body'][LANGUAGE_NONE][0]['#title'] = t('Body');
  }
  if (isset($form['field_tags'])) {
    $form['field_tags'][LANGUAGE_NONE]['#title'] = t('Tags');
  }
  if (isset($form['field_image'])) {
    $form['field_image'][LANGUAGE_NONE]['#title'] = t('image');
  }
  switch ($form_id) {
    case 'question_node_form':
      $form['title']['#access'] = FALSE;
      $p_nid = arg(1);
      if (isset($p_nid) && $p_nid > 0) { // Ask form for Center
        $p_node = node_load($p_nid);
        $p_type = $p_node->type;
        if ($p_type == 'sbq_center') {
          $form['body']['und']['0']['#title'] = t('问答');
          $form['field_tags']['und']['#value'] = '中心问答';
          $form['actions']['submit']['#submit'][] = 'sbq_center_ask_form_submit';
          unset($form['#validate']);
          unset($form['#submit']);
          unset($form['body']['und']['0']['format']);
          unset($form['body']['und']['0']['summary']);
          $form['actions']['submit'] = array(
            '#type' => 'submit',
            '#value' => '提问',
            //'#attributes' => array('class'=>'use-ajax'),
            '#ajax' => array(
                'callback' => 'ajax_center_ask_callback',
                'wrapper' => 'question-node-form',
                'method' => 'replace',
                'effect' => 'fade',
                'progress' => array( 'type' => 'throbber', 'message' => '请稍候' ),
            ),
          );
        }
      }
      break;
    default:
      break;
  }
}

function sbq_center_ask_form_submit($form, &$form_state) {
  $form_state['redirect'] = FALSE;
  dpm($form_state);
}

/*
 * ajax_center_ask_callback
 */
function ajax_center_ask_callback($form, &$form_state) {
  $body = $form_state['input']['body']['und'][0]['value'];
  if (isset($body) && strlen(trim($body))>0) {
    $commands = array();
    module_load_include('inc', 'node', 'node.pages');
    $node = node_form_submit_build_node($form, $form_state);
    $insert = empty($node->nid);
    node_save($node);
    $node_link = l(t('view'), 'node/' . $node->nid);
    $watchdog_args = array(
      '@type' => $node->type,
      '%title' => $node->title,
    );

    if ($insert) {
      watchdog('content', '@type: added %title.', $watchdog_args, WATCHDOG_NOTICE, $node_link);
    }
    if ($node->nid) {
      $form_state['values']['nid'] = $node->nid;
      $form_state['nid'] = $node->nid;
      $title = l($node->title, 'node/' . $node->nid);
      $str_date = format_date(time(),'custom','Y-m-d');
      $nqs  = '<div class="views-row views-row-1 views-row-odd views-row-first">'
        . '<div class="views-field views-field-title"><span class="field-content">'.$title.'</span></div>'
        . '<div class="views-field views-field-field-mark-question-resolved"><div class="field-content">未解决</div></div>'
        . '<div class="views-field views-field-created"><span class="field-content">'.$str_date.'</span></div></div>';
      $success_msg = '<div class="messages--status messages status">'
        .'<h2 class="element-invisible">状态消息</h2>'
        .'<pre>'.$node->title.' 已经提交给中心</pre></div>';
      $new_textarea = '<textarea class="text-full ckeditor-mod form-textarea" id="edit-body-und-0-value" name="body[und][0][value]" cols="60" rows="20"></textarea>';
      $commands[] = ajax_command_replace('#edit-body-und-0-value', $new_textarea);
      $commands[] = ajax_command_after('#main-content', $success_msg);
      $commands[] = ajax_command_prepend('#block-views-my-qa-center-new .view-content', $nqs);
      // $commands[] = ajax_command_replace('#sbq-message-error', '');
    }
    else {
      // In the unlikely case something went wrong on save, the node will be
      // rebuilt and node form redisplayed the same way as in preview.
      drupal_set_message(t('The post could not be saved.'), 'error');
      $form_state['rebuild'] = TRUE;
    }
  } else {
    $error_msg = '<div id="sbq-message-error" class="messages--error messages error">'
      .'<h2 class="element-invisible">错误信息</h2>'
      .'<ul class="messages__list">'
      .'<li class="messages__item">请输入您的问题</li>'
      .'</ul></div>';
    $commands[] = ajax_command_after('#main-content', $error_msg);
    $form_state['rebuild'] = TRUE;
  }

  $page = array(
      '#type' => 'ajax',
      '#commands' => $commands );
  ajax_deliver($page);
}
