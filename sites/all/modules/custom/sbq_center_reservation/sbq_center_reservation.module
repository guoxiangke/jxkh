<?php

/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
/**
 * 预约门诊类型
 */
define('SBQ_CENTER_RESERVATION_TYPE_OUTPATIMENT', 0);
/**
 * 预约电话类型
 */
define('SBQ_CENTER_RESERVATION_TYPE_PHONE', 1);
/**
 * 预约表单id
 */
define('SBQ_CENTER_RESERVATION_NODE_ID', 21749);

/**
 * hook menu
 */
function sbq_center_reservation_menu() {
  $items['node/%/reservation/%'] = array(
      'page callback' => 'sbq_center_reservation',
      'page arguments' => array( 1, 3 ),
      'access callback' => 'sbq_center_reservation_access',
      'access arguments' => array( 'form', NULL ),
      'file' => 'sbq_center_reservation.inc',
      'type' => MENU_CALLBACK,
  );

  return $items;
}

function sbq_center_reservation_access($type, $account = NULL) {
  return TRUE;
}

/*
 * hook_form_alter
 */

//function sbq_center_reservation_form_alter(&$form, $form_state, $form_id) {
//  if (strpos($form_id, 'webform_client_form_') !== FALSE) {
//    $nid = str_replace('webform_client_form_', '', $form_id);
//    if ($nid == SBQ_CENTER_RESERVATION_NODE_ID) {
//      if ($sbq_center = sbq_center_get_center()) {
////        $form['submitted']['sbq_center_id']['#value'] = $sbq_center->nid;
////        $form['submitted']['sbq_center_formcategory']['#value'] = SBQ_CENTER_RESERVATION_TYPE_OUTPATIMENT;
//        dpm($form);
//        $webform['submitted']['sbq_center_name']['#value'] = '斯蒂芬';
//      }
//    }
//  }
//  dpm($form_id);
//}

/**
 * get sbq center reservation form only in sbq center page true running
 * @return type
 */
function sbq_center_reservation_sheet($sbq_center_reservation_type) {
  if ($sbq_center = sbq_center_get_center()) {
    $node = node_load(SBQ_CENTER_RESERVATION_NODE_ID);
    webform_node_view($node, 'full');
    $webform = $node->content['webform']['#form'];
    $webform['submitted']['sbq_center_id']['#value'] = $sbq_center->nid;
    $webform['submitted']['sbq_center_formcategory']['#value'] = $sbq_center_reservation_type;
  }
  return isset($webform) ? $webform : '';
}

/**
 *  hook_webform_submission_insert
 * @param type $node
 * @param type $submission
 */
function sbq_center_reservation_webform_submission_insert($node, $submission) {
  global $user;
  $title = $user->name;
  if ($user->uid != $submission->uid) {
    $account = user_load($submission->uid);
    $title = $account->name;
  }
  db_insert('webform_submissions_center_reservation')
      ->fields(array(
          'sid' => $submission->sid,
          'nid' => $node->nid,
          'cid' => $submission->data[9]['value'][0],
          'uid' => $submission->uid,
          'type'=> $submission->data[10]['value'][0],
          'is_draft' => $submission->is_draft,
          'submitted' => $submission->submitted,
          'remote_addr' => $submission->remote_addr,
          'short_title' => $title,
      ))->execute();
}
