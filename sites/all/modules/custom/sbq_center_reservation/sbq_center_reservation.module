<?php

/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
define('SBQ_CENTER_RESERVATION_NODE_TYPE', 'sbq_center_reservation');
define('SBQ_CENTER_RESERVATION_STATUS_SUBMMIT', 0);
define('SBQ_CENTER_RESERVATION_STATUS_ACCEPT', 1);
define('SBQ_CENTER_RESERVATION_STATUS_IGNORE', 2);

/**
 * hook  menu
 * @return array
 */
function sbq_center_reservation_menu() {
  $items['center/%sbq_center/reservation/settings'] = array(
      'title' => '设置接诊日期',
      'page callback' => 'drupal_get_form',
      'page arguments' => array( 'sbq_center_opendays_form', 1 ),
      'access callback' => 'sbq_center_reservation_access',
      'access arguments' => array( 1 ),
      'type' => MENU_NORMAL_ITEM,
      'file' => 'sbq_center_reservation.inc'
  );
  $items['center/%sbq_center/reservation/add'] = array(
      'title' => '预约',
      'page callback' => 'sbq_center_reservation_add',
      'page arguments' => array( 1, 'add' ),
      'access callback' => 'sbq_center_reservation_access',
      'access arguments' => array( 2 ),
      'type' => MENU_NORMAL_ITEM,
      'file' => 'sbq_center_reservation.inc'
  );

  foreach (array( 'accept', 'ignore' ) as $key => $value) {
    $items['center/%sbq_center/reservation/%sbq_center_reservation/' . $value] = array(
        'title' => '预约',
        'page callback' => 'sbq_center_reservation_manage',
        'page arguments' => array( 1, 3, 4 ),
        'access callback' => 'sbq_center_reservation_access',
        'access arguments' => array( 1, 4 ),
        'type' => MENU_NORMAL_ITEM,
        'file' => 'sbq_center_reservation.inc'
    );
  }
  return $items;
}

function sbq_center_reservation_access($center, $type = 'NULL') {
  if (!$center)
    return FALSE;
  return TRUE;
}

function sbq_center_reservation_load($rid) {
  if (!$reservation = node_load($rid)) {
    return NULL;
  }
  return $reservation->type == SBQ_CENTER_RESERVATION_NODE_TYPE ? $reservation : NULL;
}

/**
 * get reservation settings
 * @param type $type
 */
function sbq_center_reservation_setopenday($centerid, $opendays) {
  if (!$center_node = sbq_center_load($centerid)) {
    throw new Exception("The parameter {$center_node} is not Center Node");
  }
}

function sbq_center_reservation_get_settings($center) {
  static $center_reservation_opendays = array();

//  if (!is_object($center)) {
//    if (isset($center_reservation_opendays[$center])) {
//      return $center_reservation_opendays[$center];
//    } else {
//      $center = sbq_center_load($center);
//    }
//  }
//
//  if (!isset($center) || $center->type != SBQ_CENTER_NODE_TYPE) {
//    throw new Exception('the node is not sbq center reservation');
//  }
//  if (isset($center_reservation_opendays[$center->nid])) {
//    return $center_reservation_opendays[$center->nid];
//  }
//  if (!$center) {
//    return array();
//  }
  $center = sbq_center_load($center);

  if (!$vari = variable_get('center_reservation_' . $center->nid . '_settings')) {
    return array();
  }
  $center_reservation_opendays[$center->nid] = unserialize($vari);
  return $center_reservation_opendays[$center->nid];
}

function sbq_center_reservation_theme_registry_alter(&$theme_registry) {
  if (arg(2) == 'reservation') {
    $theme_registry['calendar_month_col']['path'] = drupal_get_path('module', 'sbq_center_reservation');
    $theme_registry['calendar_month_col']['template'] = '/templates/' . $theme_registry['calendar_month_col']['template'];
    $theme_registry['calendar_month_col']['preprocess functions'][] = 'template_preprocess_sbq_center_reservation_month_col';

    $theme_registry['calendar_item']['path'] = drupal_get_path('module', 'sbq_center_reservation');
    $theme_registry['calendar_item']['template'] = '/templates/' . $theme_registry['calendar_item']['template'];
    $theme_registry['calendar_item']['preprocess functions'][] = 'template_preprocess_sbq_center_reservation_item';
  }
}

/**
 * @see template_preprocess_calendar_item()
 * @param type $vars
 */
function template_preprocess_sbq_center_reservation_item(&$vars) {
  if (isset($vars['rendered_fields'])) {
    $vars['rendered_fields'] = array();
  }
//  $item = $vars['item'];
//  $multiday_hidden = !empty($vars['view']->style_options['multiday_hidden']) ? $vars['view']->style_options['multiday_hidden'] : array();
//  if (!empty($item->rendered) && empty($item->is_multi_day)) {
//  //  $vars['rendered_fields'] = array( $item->rendered );
//  } else {
//    foreach ($vars['view']->field as $id => $field) {
//      if ($field->options['exclude'] || (!empty($item->is_multi_day) && in_array($id, $multiday_hidden))) {
//        unset($vars['rendered_fields'][$field->field]);
//      }
//    }
//  }
}

function template_preprocess_sbq_center_reservation_month_col(&$vars) {
  // dpm($vars);
}

/**
 * 
 * @param type $date
 * @param type $center
 * @return boolean
 */
function sbq_center_reservation_can_reservation($date, $center = '') {
  if (!$center) {
    $center = arg(1);
  }
  $settings = sbq_center_reservation_get_settings($center);
  $week_index = date_day_of_week($date);
  $week = array(
      'sunday',
      'monday',
      'tuesday',
      'wednesday',
      'thursday',
      'friday',
      'saturday',
  );
  if (strtotime($date) < time()) {
    return FALSE;
  }
  $reservation = $settings['opendays'][$week[$week_index]];

  return $reservation['a'] || $reservation['b'];
}

/*
 * hook_form_alter
 */

function sbq_center_reservation_form_alter(&$form, $form_states) {

  if (isset($form['#bundle']) && $form['#bundle'] == SBQ_CENTER_RESERVATION_NODE_TYPE && isset($form['#node']) && !isset($form['#node']->nid)) {
    $param = drupal_get_query_parameters();
    if ($param['target_id']) {
      $node = node_load($param['target_id']);
      $form['og_group_ref'][LANGUAGE_NONE][0]['target_id']['#default_value'] = "$node->title ($node->nid)";
      $form['og_group_ref'][LANGUAGE_NONE]['#default_value'] = $node->nid;
      $form['og_group_ref'][LANGUAGE_NONE]['#attributes']['disabled'] = TRUE;
    }
    $form['#validate'][] = 'sbq_center_reservation_form_validate';
  }
}

/*
 * sbq center reservation validate
 */

function sbq_center_reservation_form_validate($form, &$form_states) {
  // file_put_contents('/home/chechao/1.log', $form_states['values']['field_node_ref']['und'][0]['target_id']);
  dpm($form_states);

  if (!sbq_center_reservation_can_reservation($form_states['values']['field_reservation_time']['und'][0]['value'], $form_states['values']['og_group_ref']['und'][0]['target_id'])) {
    form_set_error('field_reservation_time ', '您输入的预约时间不能预约');
  }
}

/**
 * get reservation node of one center
 * @param type $centerids
 */
function sbq_center_reservation_fetch_by_center($centerid) {
  if (!$center = sbq_center_load($centerid)) {
    throw new Exception("the center $centerid is not center");
  }

  $query = new EntityFieldQuery();
  $result = $query->entityCondition('entity_type', 'node')
      ->propertyCondition('type', SBQ_CENTER_RESERVATION_NODE_TYPE)
      ->fieldCondition('node_ref', 'target_id', $center->nid)
      ->execute();
  if (!isset($result['node'])) {
    return FALSE;
  }
  $reservationid = reset(array_keys($result['node']));
  return node_load($reservationid);
}

function sbq_center_reservation_node_submit($node, $form, $form_state) {
  dpm($node);
  dpm($form);
  dpm($form_state);
}

/**
 * 
 * @param type $uid
 * @param type $nid
 * @param array $parameters array(target_id ,pagesize)
 */
function sbq_center_reservation_get_reservation($uid = '', $nid = '', array $parameters) {
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node')
      ->propertyCondition('type', SBQ_CENTER_RESERVATION_NODE_TYPE);
  if ($uid) {
    $query->entityCondition('uid', $uid);
  }
  if ($nid) {
    $query->entityCondition('nid', $nid);
  }
  if (in_array('target_id', array_keys($parameters))) {
    $query->fieldCondition('node_ref', 'target_id', $parameters['target_id']);
  }
  if (in_array('page', array_keys($parameters))) {
    $query->range($parameters['page']['page'] * $parameters['page']['pagesize'], $parameters['page']['pagesize']);
  }
  $query->propertyOrderBy('created', 'DESC');

  $result = $query->execute();
  if (!isset($result['node'])) {
    return array();
  }
  return node_load_multiple(array_keys($result['node']));
}

function sbq_center_reservation_get_manage_item($row) {
  $centerid = arg(1);
  dpm(node_load($row->nid));
  $accept = $ignore = '';
  switch ($row->field_field_reservation_status[0]['raw']['value']) {
    case SBQ_CENTER_RESERVATION_STATUS_SUBMMIT:
      $accept = l('接受', "center/{$centerid}/reservation/{$row->nid}/accept");
      $ignore = l('删除', "center/{$centerid}/reservation/{$row->nid}/ignore");
      break;
    case SBQ_CENTER_RESERVATION_STATUS_ACCEPT:
      // $accept = l('接受', "center/{$centerid}/reservation/{$row->nid}/accept");
      $accept = '';
      $ignore = l('删除', "center/{$centerid}/reservation/{$row->nid}/ignore");
      break;
  }
  return $accept . $ignore;
}

function sbq_center_reservation_reservation_status_alter($reservation) {
  if ($reservation->field_reservation_status['und'][0]['value'] == SBQ_CENTER_RESERVATION_STATUS_ACCEPT) {
    global $user;
    $message = message_create('sbq_center_reservation_accept', array(
        'arguments' => array( '!time' => $reservation->field_reservation_time['und'][0]['value'], )
        ), $user);
    $warpper = entity_metadata_wrapper('message', $message);
    $warpper->field_node_ref->set(node_load($reservation->og_group_ref['und'][0]['target_id']));
    $warpper->save();
  
  }
}
